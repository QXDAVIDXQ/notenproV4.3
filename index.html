<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotenManager Pro - Ultimate</title>
    
    <!-- 1. Design & Core Libraries -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- 3. Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a',
                        },
                        accent: {
                            500: '#8b5cf6', 600: '#7c3aed',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; overflow-x: hidden; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .gradient-text {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;

        // --- ICONS (Lucide Style) ---
        const Icon = ({ name, size = 20, className = '' }) => {
            const paths = {
                Plus: <path d="M12 5v14M5 12h14" />,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                BarChart2: <><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></>,
                Layout: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></>,
                FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>,
                MoreHorizontal: <><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></>,
                ChevronRight: <polyline points="9 18 15 12 9 6"/>,
                TrendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>,
                Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                Award: <><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>,
                Beaker: <><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {paths[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- CHART ENGINE (Custom SVG with Bezier Curves) ---
        const ChartEngine = {
            // Smooth curve algorithm (Catmull-Rom spline to Bezier conversion for SVG)
            getSmoothPath: (points, height, width) => {
                if (points.length === 0) return "";
                if (points.length === 1) return `M 0 ${points[0].y} L ${width} ${points[0].y}`;

                // Helper to get point coordinates
                const p = (i) => {
                    // Clamp index
                    const idx = Math.max(0, Math.min(points.length - 1, i));
                    return points[idx];
                };

                let d = `M ${points[0].x} ${points[0].y}`;

                for (let i = 0; i < points.length - 1; i++) {
                    const p0 = p(i - 1);
                    const p1 = p(i);
                    const p2 = p(i + 1);
                    const p3 = p(i + 2);

                    const cp1x = p1.x + (p2.x - p0.x) / 6;
                    const cp1y = p1.y + (p2.y - p0.y) / 6;
                    const cp2x = p2.x - (p3.x - p1.x) / 6;
                    const cp2y = p2.y - (p3.y - p1.y) / 6;

                    d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
                }
                return d;
            }
        };

        // --- CONSTANTS ---
        const GRADE_TYPES = [
            { type: 'Schulaufgabe', category: 'GL', label: 'Schulaufgabe' },
            { type: 'Kurzarbeit', category: 'KL', label: 'Kurzarbeit' },
            { type: 'Ex', category: 'KL', label: 'Stegreifaufgabe' },
            { type: 'Abfrage', category: 'KL', label: 'Abfrage' },
            { type: 'Referat', category: 'KL', label: 'Referat' },
            { type: 'Unterrichtsbeitrag', category: 'KL', label: 'Mündlich' },
            { type: 'Sonstiges', category: 'KL', label: 'Sonstiges' },
        ];

        // --- LOGIC ---
        const calculateStats = (subject) => {
            const grades = subject.grades;
            const glGrades = grades.filter(g => g.category === 'GL');
            const klGrades = grades.filter(g => g.category === 'KL');

            const avg = (arr) => {
                if (!arr.length) return null;
                const sum = arr.reduce((acc, g) => acc + (g.value * g.weight), 0);
                const w = arr.reduce((acc, g) => acc + g.weight, 0);
                return w === 0 ? 0 : sum / w;
            };

            const glAvg = avg(glGrades);
            const klAvg = avg(klGrades);
            let final = null;

            if (subject.isCore) {
                if (glAvg && klAvg) final = (glAvg * 2 + klAvg) / 3;
                else if (glAvg) final = glAvg;
                else if (klAvg) final = klAvg;
            } else {
                final = avg(grades); // Alles zählt gleich im Nebenfach (bzw. ist KL)
            }
            return { avg: final, glAvg, klAvg, count: grades.length };
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- COMPONENTS ---

        // 1. ADVANCED CHART COMPONENT
        const AdvancedLineChart = ({ data, color = "#3b82f6", height = 200 }) => {
            if (!data || data.length < 2) return <div className="flex items-center justify-center h-full text-gray-400 text-sm">Zu wenig Daten für Verlauf</div>;

            const maxVal = 6;
            const minVal = 1;
            const padding = 20;
            
            // Normalize data to SVG coordinates
            const points = data.map((d, i) => ({
                x: (i / (data.length - 1)) * 100, // 0 to 100
                y: 100 - ((d.value - minVal) / (maxVal - minVal)) * 100 // 0 to 100 (inverted for SVG)
            }));

            // Scale to viewbox
            const scaledPoints = points.map(p => ({
                x: p.x, // x remains 0-100%
                y: p.y  // y remains 0-100%
            }));

            const pathD = ChartEngine.getSmoothPath(scaledPoints, 100, 100);
            const areaD = `${pathD} L 100 100 L 0 100 Z`;

            return (
                <div className="w-full relative" style={{ height: `${height}px` }}>
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full overflow-visible">
                        <defs>
                            <linearGradient id={`grad-${color}`} x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stopColor={color} stopOpacity="0.4" />
                                <stop offset="100%" stopColor={color} stopOpacity="0" />
                            </linearGradient>
                        </defs>
                        {/* Grid Lines */}
                        {[1, 2, 3, 4, 5, 6].map(n => {
                            const y = 100 - ((n - 1) / 5) * 100;
                            return <line key={n} x1="0" y1={y} x2="100" y2={y} stroke="#f1f5f9" strokeWidth="0.5" vectorEffect="non-scaling-stroke" />;
                        })}
                        
                        {/* Area */}
                        <path d={areaD} fill={`url(#grad-${color})`} />
                        
                        {/* Line */}
                        <path d={pathD} fill="none" stroke={color} strokeWidth="3" vectorEffect="non-scaling-stroke" strokeLinecap="round" strokeLinejoin="round" />
                        
                        {/* Points */}
                        {scaledPoints.map((p, i) => (
                            <g key={i} className="group">
                                <circle cx={p.x} cy={p.y} r="4" fill="white" stroke={color} strokeWidth="2" vectorEffect="non-scaling-stroke" className="transition-all duration-300 group-hover:r-6" />
                                {/* Tooltip Logic via CSS */}
                                <g className="opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                    <rect x={p.x - 15} y={p.y - 15} width="30" height="12" rx="2" fill="#1e293b" />
                                    <text x={p.x} y={p.y - 7} textAnchor="middle" fill="white" fontSize="6" fontWeight="bold">{data[i].value.toFixed(2)}</text>
                                </g>
                            </g>
                        ))}
                    </svg>
                </div>
            );
        };

        // 2. MAIN APP
        const GradeManager = () => {
            // --- STATE ---
            const [subjects, setSubjects] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [simMode, setSimMode] = useState(false);
            const [simulatedGrades, setSimulatedGrades] = useState({}); // { subjectId: [Grade...] }
            const [isModalOpen, setModalOpen] = useState(false);
            const [modalType, setModalType] = useState(null); // 'addSubject', 'addGrade'
            
            // --- PERSISTENCE ---
            useEffect(() => {
                const load = localStorage.getItem('notenmanager_v5_ultimate');
                if(load) setSubjects(JSON.parse(load));
                else setSubjects([
                    { id: '1', name: 'Deutsch', isCore: true, grades: [] },
                    { id: '2', name: 'Mathematik', isCore: true, grades: [] },
                    { id: '3', name: 'Englisch', isCore: true, grades: [] }
                ]);
            }, []);

            useEffect(() => {
                if(subjects.length) localStorage.setItem('notenmanager_v5_ultimate', JSON.stringify(subjects));
            }, [subjects]);

            // --- COMPUTED DATA ---
            const getEffectiveSubjects = () => {
                return subjects.map(sub => {
                    if(!simMode) return sub;
                    const sims = simulatedGrades[sub.id] || [];
                    return { ...sub, grades: [...sub.grades, ...sims] };
                });
            };

            const effectiveSubjects = getEffectiveSubjects();
            
            // Global Stats
            const globalAvg = (() => {
                const avgs = effectiveSubjects.map(s => calculateStats(s).avg).filter(a => a !== null);
                if(!avgs.length) return 0;
                return (avgs.reduce((a,b)=>a+b,0) / avgs.length).toFixed(2);
            })();

            // History Data Calculation (Global)
            const globalHistory = useMemo(() => {
                const allDates = [...new Set(effectiveSubjects.flatMap(s => s.grades.map(g => g.date)))].sort();
                if(allDates.length < 2) return [];
                
                return allDates.map(date => {
                    const current = new Date(date);
                    const subAvgsAtDate = effectiveSubjects.map(s => {
                        const gradesUntil = s.grades.filter(g => new Date(g.date) <= current);
                        return calculateStats({...s, grades: gradesUntil}).avg;
                    }).filter(a => a !== null);
                    
                    if(!subAvgsAtDate.length) return null;
                    return {
                        date,
                        value: subAvgsAtDate.reduce((a,b)=>a+b,0) / subAvgsAtDate.length
                    };
                }).filter(d => d !== null);
            }, [effectiveSubjects]);

            // --- ACTIONS ---
            const addSubject = (name, isCore) => {
                setSubjects([...subjects, { id: generateId(), name, isCore, grades: [] }]);
                setModalOpen(false);
            };

            const addGrade = (subjectId, gradeData) => {
                if(simMode) {
                    const newSim = { ...gradeData, id: generateId(), isSimulated: true };
                    setSimulatedGrades(prev => ({ ...prev, [subjectId]: [...(prev[subjectId]||[]), newSim] }));
                } else {
                    setSubjects(prev => prev.map(s => s.id === subjectId ? { ...s, grades: [...s.grades, { ...gradeData, id: generateId() }] } : s));
                }
                setModalOpen(false);
            };

            const deleteGrade = (subjectId, gradeId, isSim) => {
                if(isSim) {
                    setSimulatedGrades(prev => ({ ...prev, [subjectId]: prev[subjectId].filter(g => g.id !== gradeId) }));
                } else {
                    setSubjects(prev => prev.map(s => s.id === subjectId ? { ...s, grades: s.grades.filter(g => g.id !== gradeId) } : s));
                }
            };

            const downloadPDF = async () => {
                const element = document.getElementById('certificate-print-area');
                if(!element) return;
                
                // Use html2canvas to capture the element
                const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#ffffff" });
                const imgData = canvas.toDataURL('image/png');
                
                // Use jspdf
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('Zwischenzeugnis.pdf');
            };

            // --- RENDERERS ---

            const renderDashboard = () => (
                <div className="space-y-8 animate-fade-in">
                    {/* Header Card */}
                    <div className="relative overflow-hidden rounded-3xl bg-gradient-to-br from-brand-600 to-accent-600 p-8 text-white shadow-2xl">
                        <div className="absolute top-0 right-0 -mr-16 -mt-16 h-64 w-64 rounded-full bg-white opacity-10 blur-3xl"></div>
                        <div className="absolute bottom-0 left-0 -ml-16 -mb-16 h-48 w-48 rounded-full bg-indigo-900 opacity-20 blur-3xl"></div>
                        
                        <div className="relative z-10 flex flex-col md:flex-row justify-between items-end gap-6">
                            <div>
                                <h1 className="text-4xl font-serif font-bold tracking-tight mb-2">Willkommen zurück!</h1>
                                <p className="text-blue-100 opacity-90">Hier ist dein aktueller Leistungsstand im Überblick.</p>
                            </div>
                            <div className="flex flex-col items-end">
                                <span className="text-sm font-bold uppercase tracking-wider opacity-70">Gesamtschnitt</span>
                                <span className="text-6xl font-sans font-extrabold">{globalAvg > 0 ? globalAvg : '-'}</span>
                            </div>
                        </div>
                    </div>

                    {/* Chart Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 bg-white rounded-3xl p-6 shadow-lg shadow-slate-200/50 border border-slate-100">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-gray-800 flex items-center gap-2"><Icon name="TrendingUp" className="text-brand-500"/> Notenentwicklung</h3>
                                <span className="text-xs font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-full">Gesamtverlauf</span>
                            </div>
                            <div className="h-64">
                                <AdvancedLineChart data={globalHistory} />
                            </div>
                        </div>

                        {/* Quick Stats / Sim Mode Toggle */}
                        <div className="space-y-6">
                            <div className={`rounded-3xl p-6 shadow-lg transition-all duration-300 border ${simMode ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100'}`}>
                                <h3 className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                    <Icon name="Beaker" className={simMode ? "text-blue-600" : "text-gray-400"}/> 
                                    Simulations-Modus
                                </h3>
                                <p className="text-sm text-gray-500 mb-4">Teste Noten, ohne dein echtes Zeugnis zu verändern.</p>
                                <button onClick={() => setSimMode(!simMode)} className={`w-full py-3 rounded-xl font-bold transition-all ${simMode ? 'bg-blue-600 text-white shadow-lg shadow-blue-300' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                                    {simMode ? 'Simulation beenden' : 'Starten'}
                                </button>
                            </div>

                            <div className="bg-white rounded-3xl p-6 shadow-lg border border-slate-100">
                                <h3 className="font-bold text-gray-800 mb-4">Verteilung</h3>
                                <div className="flex items-end justify-between h-32 gap-2">
                                    {[1,2,3,4,5,6].map(n => {
                                        const count = effectiveSubjects.flatMap(s => s.grades).filter(g => Math.round(g.value) === n).length;
                                        const max = Math.max(...[1,2,3,4,5,6].map(num => effectiveSubjects.flatMap(s => s.grades).filter(g => Math.round(g.value) === num).length)) || 1;
                                        const h = (count / max) * 100;
                                        return (
                                            <div key={n} className="w-full flex flex-col items-center group">
                                                <div style={{height: `${h || 5}%`}} className={`w-full rounded-t-lg transition-all duration-500 ${n <= 2 ? 'bg-emerald-400' : n <= 4 ? 'bg-amber-400' : 'bg-red-400'}`}></div>
                                                <span className="text-xs font-bold mt-2 text-gray-400">{n}</span>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Subjects Grid */}
                    <div>
                        <h3 className="text-xl font-bold text-gray-800 mb-6 px-2">Deine Fächer</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            {effectiveSubjects.map(sub => {
                                const stats = calculateStats(sub);
                                return (
                                    <div key={sub.id} onClick={() => { setSelectedSubject(sub.id); setActiveTab('details'); }} 
                                         className="group bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border border-slate-100 cursor-pointer relative overflow-hidden">
                                        <div className={`absolute top-0 left-0 w-2 h-full ${sub.isCore ? 'bg-brand-500' : 'bg-emerald-400'}`}></div>
                                        <div className="flex justify-between items-start mb-4 pl-3">
                                            <div>
                                                <h4 className="font-bold text-lg text-gray-800 group-hover:text-brand-600 transition-colors">{sub.name}</h4>
                                                <span className="text-xs text-gray-400">{sub.isCore ? 'Kernfach' : 'Nebenfach'}</span>
                                            </div>
                                            {simMode && sub.grades.some(g=>g.isSimulated) && <span className="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded-full">SIM</span>}
                                        </div>
                                        <div className="pl-3">
                                            <span className="text-4xl font-extrabold text-slate-800">{stats.avg ? stats.avg.toFixed(2) : '-'}</span>
                                        </div>
                                    </div>
                                )
                            })}
                            <button onClick={() => { setModalType('addSubject'); setModalOpen(true); }} className="rounded-3xl border-2 border-dashed border-slate-300 p-6 flex flex-col items-center justify-center text-slate-400 hover:border-brand-400 hover:text-brand-500 hover:bg-brand-50 transition-all gap-2 min-h-[160px]">
                                <div className="bg-slate-100 rounded-full p-3 group-hover:bg-brand-100 transition-colors"><Icon name="Plus" /></div>
                                <span className="font-bold">Fach hinzufügen</span>
                            </button>
                        </div>
                    </div>
                </div>
            );

            const renderDetails = () => {
                const sub = effectiveSubjects.find(s => s.id === selectedSubject);
                if(!sub) return null;
                const stats = calculateStats(sub);
                
                // Subject History
                const history = sub.grades.sort((a,b)=>new Date(a.date)-new Date(b.date)).map((g, i, arr) => {
                    const subset = arr.slice(0, i+1);
                    return { value: calculateStats({...sub, grades: subset}).avg, date: g.date };
                });

                return (
                    <div className="space-y-8 animate-slide-up pb-20">
                        <button onClick={() => setActiveTab('dashboard')} className="flex items-center text-sm font-bold text-gray-400 hover:text-brand-600 transition-colors mb-4"><span className="mr-1">←</span> Zurück zur Übersicht</button>
                        
                        {/* Header */}
                        <div className="flex flex-col md:flex-row justify-between items-end bg-white p-8 rounded-3xl shadow-xl border border-slate-100">
                            <div>
                                <div className="flex items-center gap-3">
                                    <h1 className="text-4xl font-serif font-bold text-gray-900">{sub.name}</h1>
                                    <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${sub.isCore ? 'bg-brand-100 text-brand-700' : 'bg-emerald-100 text-emerald-700'}`}>{sub.isCore ? 'Kernfach' : 'Nebenfach'}</span>
                                </div>
                                <p className="text-gray-500 mt-2">Detaillierte Analyse & Notenverwaltung</p>
                            </div>
                            <div className="text-right mt-6 md:mt-0">
                                <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Aktueller Schnitt</div>
                                <div className={`text-6xl font-extrabold ${simMode ? 'text-blue-600' : 'text-gray-900'}`}>{stats.avg ? stats.avg.toFixed(2) : '-'}</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {/* Breakdown Cards */}
                            <div className="bg-white p-6 rounded-3xl shadow-lg border-l-4 border-brand-500">
                                <span className="text-gray-400 font-bold text-xs uppercase">Schriftlich (GL)</span>
                                <div className="text-3xl font-bold text-gray-800 mt-2">{stats.glAvg ? stats.glAvg.toFixed(2) : '-'}</div>
                                <div className="text-xs text-brand-600 font-medium mt-1">{sub.isCore ? 'Gewichtung 2x' : 'Gewichtung 1x'}</div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl shadow-lg border-l-4 border-emerald-500">
                                <span className="text-gray-400 font-bold text-xs uppercase">Mündlich (KL)</span>
                                <div className="text-3xl font-bold text-gray-800 mt-2">{stats.klAvg ? stats.klAvg.toFixed(2) : '-'}</div>
                                <div className="text-xs text-emerald-600 font-medium mt-1">Gewichtung 1x</div>
                            </div>
                            
                            {/* Target Calculator Mini */}
                            <div className="bg-slate-900 p-6 rounded-3xl text-white shadow-xl flex flex-col justify-center">
                                <div className="flex items-center gap-2 mb-2 text-brand-400 font-bold text-sm"><Icon name="Award" size={16}/> Zielrechner</div>
                                <div className="text-xs text-slate-400 mb-3">Welche Note brauchst du für...</div>
                                <div className="flex gap-2">
                                    <input type="number" placeholder="z.B. 2.0" id="targetInput" className="w-full bg-slate-800 border-none rounded-lg px-3 py-2 text-sm text-white focus:ring-1 focus:ring-brand-500" />
                                    <button onClick={() => {
                                        const t = parseFloat(document.getElementById('targetInput').value);
                                        if(!t) return;
                                        // Simple Calc logic
                                        for(let i=0.75; i<=6; i+=0.25) {
                                            const testG = [...sub.grades, { value: i, weight: 1, category: 'KL' }];
                                            const newAvg = calculateStats({...sub, grades: testG}).avg;
                                            if((t < stats.avg && newAvg <= t) || (t > stats.avg && newAvg >= t)) {
                                                alert(`Eine ${i.toFixed(2)} (KL) würde reichen!`); return;
                                            }
                                        }
                                        alert("Schwer erreichbar mit einer Note.");
                                    }} className="bg-brand-600 hover:bg-brand-500 px-4 rounded-lg font-bold text-xs">Calc</button>
                                </div>
                            </div>
                        </div>

                        {/* Chart */}
                        <div className="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                            <h3 className="font-bold text-gray-800 mb-6">Verlauf</h3>
                            <AdvancedLineChart data={history} color={sub.isCore ? '#3b82f6' : '#10b981'} height={250} />
                        </div>

                        {/* List */}
                        <div className="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <h3 className="font-bold text-gray-800">Notenliste</h3>
                                <button onClick={() => { setModalType('addGrade'); setModalOpen(true); }} className="flex items-center gap-2 bg-black text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg hover:scale-105 transition-transform">
                                    <Icon name="Plus" size={16}/> Note
                                </button>
                            </div>
                            <table className="w-full text-left text-sm">
                                <thead className="text-gray-400 uppercase font-bold bg-white border-b border-slate-100">
                                    <tr><th className="p-4 pl-6">Datum</th><th className="p-4">Art</th><th className="p-4">Note</th><th className="p-4 text-right"></th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {sub.grades.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(g => (
                                        <tr key={g.id} className={`hover:bg-slate-50 transition-colors ${g.isSimulated ? 'bg-blue-50/50' : ''}`}>
                                            <td className="p-4 pl-6 font-medium text-gray-500">{new Date(g.date).toLocaleDateString()}</td>
                                            <td className="p-4">
                                                <div className="font-bold text-gray-800">{g.type}</div>
                                                <div className="text-xs text-gray-400 uppercase tracking-wider">{g.category} • x{g.weight}</div>
                                            </td>
                                            <td className="p-4">
                                                <span className={`text-lg font-bold ${g.value <= 2 ? 'text-emerald-600' : g.value <= 4 ? 'text-amber-600' : 'text-red-600'}`}>
                                                    {g.value}{g.trend}
                                                </span>
                                                {g.isSimulated && <span className="ml-2 bg-blue-100 text-blue-700 text-[10px] px-1.5 rounded font-bold">SIM</span>}
                                            </td>
                                            <td className="p-4 text-right pr-6">
                                                <button onClick={() => deleteGrade(sub.id, g.id, g.isSimulated)} className="text-gray-300 hover:text-red-500 transition-colors p-2"><Icon name="Trash2" size={18}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {sub.grades.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400 italic">Noch keine Noten eingetragen.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const renderCertificate = () => {
                const totalAvg = effectiveSubjects.reduce((acc, s) => {
                    const a = calculateStats(s).avg; return a ? acc + a : acc;
                }, 0) / effectiveSubjects.filter(s => calculateStats(s).avg).length;

                return (
                    <div className="pb-20 animate-fade-in flex flex-col items-center">
                        <div className="w-full max-w-4xl mb-6 flex justify-end">
                            <button onClick={downloadPDF} className="bg-brand-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-brand-700 flex items-center gap-2 transition-all">
                                <Icon name="Download"/> Als PDF speichern
                            </button>
                        </div>

                        {/* Certificate Paper */}
                        <div id="certificate-print-area" className="w-full max-w-[210mm] min-h-[297mm] bg-white shadow-2xl p-16 relative text-gray-900 mx-auto">
                            {/* Watermark / BG decoration */}
                            <div className="absolute inset-0 border-[12px] border-double border-slate-100 m-4 pointer-events-none"></div>
                            
                            {/* Header */}
                            <div className="text-center mb-16 border-b-2 border-gray-900 pb-8">
                                <div className="font-serif font-bold text-5xl uppercase tracking-widest mb-4">Zwischenzeugnis</div>
                                <div className="text-xl italic text-gray-600 font-serif">Schuljahr {new Date().getFullYear()}/{new Date().getFullYear()+1}</div>
                                {simMode && <div className="mt-4 text-brand-600 font-bold uppercase tracking-widest border border-brand-200 bg-brand-50 inline-block px-4 py-1 rounded text-sm">Simulation</div>}
                            </div>

                            {/* Table */}
                            <table className="w-full border-collapse mb-12 font-serif">
                                <thead>
                                    <tr className="border-b-2 border-gray-900 text-left">
                                        <th className="py-4 text-sm font-sans font-bold text-gray-500 uppercase tracking-widest w-1/3">Fach</th>
                                        <th className="py-4 text-sm font-sans font-bold text-gray-500 uppercase tracking-widest">Leistungsnachweis</th>
                                        <th className="py-4 text-sm font-sans font-bold text-gray-500 uppercase tracking-widest text-right">Note</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {effectiveSubjects.map(sub => {
                                        const stats = calculateStats(sub);
                                        return (
                                            <tr key={sub.id} className="border-b border-gray-100">
                                                <td className="py-5 text-xl font-bold">
                                                    {sub.name}
                                                    {sub.isCore && <span className="block text-xs font-sans font-normal text-gray-400 mt-1 uppercase tracking-wider">Kernfach</span>}
                                                </td>
                                                <td className="py-5 font-sans text-sm text-gray-500">
                                                    {stats.avg ? (
                                                        sub.isCore ? 
                                                        <span>GL: <strong className="text-gray-800">{stats.glAvg?.toFixed(2)||'-'}</strong> (x2) &nbsp;|&nbsp; KL: <strong className="text-gray-800">{stats.klAvg?.toFixed(2)||'-'}</strong> (x1)</span> 
                                                        : <span>Durchschnitt aller Leistungen</span>
                                                    ) : <span className="italic opacity-50">Keine Bewertung</span>}
                                                </td>
                                                <td className="py-5 text-right font-bold text-2xl">{stats.avg ? stats.avg.toFixed(2) : '-'}</td>
                                            </tr>
                                        )
                                    })}
                                </tbody>
                                <tfoot>
                                    <tr className="border-t-4 border-double border-gray-900">
                                        <td className="py-6 text-xl font-bold uppercase tracking-widest pt-8">Gesamtschnitt</td>
                                        <td></td>
                                        <td className="py-6 text-right text-4xl font-extrabold pt-8">{totalAvg ? totalAvg.toFixed(2) : '-'}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <div className="mt-32 flex justify-between font-sans text-xs uppercase tracking-widest text-gray-400 pt-8 border-t border-gray-200">
                                <div className="text-center w-1/3">
                                    <div className="mb-2">Ort, Datum</div>
                                    <div className="font-serif text-gray-800 text-lg">{new Date().toLocaleDateString()}</div>
                                </div>
                                <div className="text-center w-1/3">
                                    <div className="h-10 border-b border-gray-400 mb-2"></div>
                                    Unterschrift Erziehungsberechtigte
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderAnalytics = () => {
                // Prepare Data
                const grades = effectiveSubjects.flatMap(s => s.grades);
                
                // 1. Month Comparison
                const months = {};
                grades.forEach(g => {
                    const k = g.date.slice(0, 7);
                    if(!months[k]) months[k] = { sum: 0, count: 0 };
                    months[k].sum += g.value; months[k].count++;
                });
                const monthData = Object.keys(months).sort().map(k => ({
                    label: k, value: months[k].sum / months[k].count
                }));

                // 2. Type Comparison
                const types = {};
                grades.forEach(g => {
                    if(!types[g.type]) types[g.type] = { sum: 0, count: 0 };
                    types[g.type].sum += g.value; types[g.type].count++;
                });
                const typeData = Object.keys(types).map(t => ({ label: t, value: types[t].sum / types[t].count, count: types[t].count }));

                return (
                    <div className="space-y-8 animate-fade-in pb-20">
                        <h1 className="text-3xl font-extrabold text-gray-900">Deep Dive Statistik</h1>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white p-8 rounded-3xl shadow-lg border border-slate-100">
                                <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2"><Icon name="BarChart2" className="text-brand-500"/> Monatlicher Trend</h3>
                                <div className="h-64 flex items-end justify-between gap-2 px-2">
                                    {monthData.map(d => {
                                        const h = ((6 - d.value) / 5) * 100;
                                        return (
                                            <div key={d.label} className="w-full bg-slate-100 rounded-t-lg relative group transition-all hover:bg-brand-50">
                                                <div style={{height: `${h}%`}} className="absolute bottom-0 w-full bg-brand-500 rounded-t-lg opacity-80 group-hover:opacity-100 transition-all"></div>
                                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">{d.value.toFixed(2)}</div>
                                                <div className="absolute -bottom-6 w-full text-center text-[10px] text-gray-400 rotate-45">{d.label}</div>
                                            </div>
                                        )
                                    })}
                                    {monthData.length===0 && <div className="w-full text-center text-gray-400 self-center">Keine Daten</div>}
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-3xl shadow-lg border border-slate-100">
                                <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2"><Icon name="Layout" className="text-accent-500"/> Nach Leistungsart</h3>
                                <div className="space-y-4">
                                    {typeData.sort((a,b)=>a.value-b.value).map(t => (
                                        <div key={t.label}>
                                            <div className="flex justify-between text-sm font-bold text-gray-700 mb-1">
                                                <span>{t.label} <span className="font-normal text-gray-400 text-xs">({t.count})</span></span>
                                                <span>{t.value.toFixed(2)} Ø</span>
                                            </div>
                                            <div className="h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                                                <div style={{width: `${((6-t.value)/5)*100}%`}} className={`h-full rounded-full ${t.value<=2.5?'bg-emerald-400':t.value<=3.5?'bg-amber-400':'bg-red-400'}`}></div>
                                            </div>
                                        </div>
                                    ))}
                                    {typeData.length===0 && <div className="text-center text-gray-400">Keine Daten</div>}
                                </div>
                            </div>
                        </div>
                    </div>
                )
            };

            // --- MAIN LAYOUT ---
            return (
                <div className="flex min-h-screen font-sans text-slate-600">
                    
                    {/* Sidebar */}
                    <nav className="w-20 lg:w-72 bg-white border-r border-slate-100 flex-shrink-0 flex flex-col sticky top-0 h-screen z-50">
                        <div className="p-6 flex items-center gap-4 border-b border-slate-50">
                            <div className="w-10 h-10 bg-gradient-to-br from-brand-600 to-accent-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-200">
                                <Icon name="Award" />
                            </div>
                            <span className="font-serif font-bold text-2xl text-gray-900 hidden lg:block">NotenPro</span>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            <button onClick={() => { setActiveTab('dashboard'); setSelectedSubject(null); }} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all font-medium ${activeTab === 'dashboard' ? 'bg-brand-50 text-brand-700 shadow-sm' : 'hover:bg-slate-50'}`}>
                                <Icon name="Layout" className={activeTab === 'dashboard' ? 'text-brand-600' : 'text-slate-400'} />
                                <span className="hidden lg:block">Dashboard</span>
                            </button>
                            <button onClick={() => { setActiveTab('analytics'); setSelectedSubject(null); }} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all font-medium ${activeTab === 'analytics' ? 'bg-brand-50 text-brand-700 shadow-sm' : 'hover:bg-slate-50'}`}>
                                <Icon name="BarChart2" className={activeTab === 'analytics' ? 'text-brand-600' : 'text-slate-400'} />
                                <span className="hidden lg:block">Statistiken</span>
                            </button>
                            
                            <div className="pt-6 pb-2 px-3 text-xs font-bold text-slate-400 uppercase tracking-widest hidden lg:block">Fächer</div>
                            {subjects.map(s => (
                                <button key={s.id} onClick={() => { setSelectedSubject(s.id); setActiveTab('details'); }} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all text-left group ${selectedSubject === s.id && activeTab === 'details' ? 'bg-slate-900 text-white shadow-lg' : 'hover:bg-slate-50'}`}>
                                    <div className={`w-2 h-2 rounded-full ${s.isCore ? 'bg-brand-500' : 'bg-emerald-400'}`}></div>
                                    <span className="hidden lg:block truncate">{s.name}</span>
                                </button>
                            ))}
                            <button onClick={() => { setModalType('addSubject'); setModalOpen(true); }} className="w-full flex items-center justify-center gap-2 p-3 mt-4 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 hover:border-brand-300 hover:text-brand-500 hover:bg-brand-50 transition-all">
                                <Icon name="Plus" size={18} />
                            </button>
                        </div>

                        <div className="p-4 border-t border-slate-100">
                            <button onClick={() => { setActiveTab('certificate'); setSelectedSubject(null); }} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all font-bold ${activeTab === 'certificate' ? 'bg-amber-100 text-amber-800' : 'bg-slate-50 hover:bg-slate-100 text-slate-600'}`}>
                                <Icon name="FileText" className="text-amber-600" />
                                <span className="hidden lg:block">Zeugnis</span>
                            </button>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="flex-1 bg-slate-50/50 p-4 lg:p-10 relative overflow-y-auto h-screen">
                        <div className="max-w-7xl mx-auto">
                            {activeTab === 'dashboard' && renderDashboard()}
                            {activeTab === 'details' && renderDetails()}
                            {activeTab === 'certificate' && renderCertificate()}
                            {activeTab === 'analytics' && renderAnalytics()}
                        </div>
                    </main>

                    {/* Modal Overlay */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md relative animate-slide-up">
                                <button onClick={() => setModalOpen(false)} className="absolute top-6 right-6 text-slate-400 hover:text-slate-600"><Icon name="Trash2" className="rotate-45" size={24}/></button> {/* X Icon workaround using rotated trash or just text X */}
                                <div className="absolute top-6 right-6 cursor-pointer" onClick={()=>setModalOpen(false)}>✕</div>
                                
                                <h2 className="text-2xl font-serif font-bold text-gray-900 mb-6">{modalType === 'addSubject' ? 'Neues Fach' : 'Neue Note'}</h2>
                                
                                {modalType === 'addSubject' ? (
                                    <form onSubmit={(e) => { e.preventDefault(); addSubject(e.target.name.value, e.target.core.checked); }}>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Fachname</label>
                                                <input name="name" autoFocus required className="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 font-bold focus:ring-2 focus:ring-brand-500 outline-none" placeholder="z.B. Chemie" />
                                            </div>
                                            <div className="flex items-center gap-3 bg-slate-50 p-4 rounded-xl">
                                                <input type="checkbox" name="core" id="coreCheck" className="w-5 h-5 text-brand-600 rounded focus:ring-brand-500 border-gray-300" />
                                                <label htmlFor="coreCheck" className="font-bold text-slate-700">Kernfach (Schulaufgaben?)</label>
                                            </div>
                                            <button type="submit" className="w-full bg-black text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition-colors mt-4">Erstellen</button>
                                        </div>
                                    </form>
                                ) : (
                                    <form onSubmit={(e) => { 
                                        e.preventDefault(); 
                                        const fd = new FormData(e.target);
                                        const t = fd.get('type');
                                        const c = GRADE_TYPES.find(x=>x.type===t)?.defaultCategory || 'KL';
                                        addGrade(selectedSubject, {
                                            value: parseInt(fd.get('value')),
                                            trend: fd.get('trend'),
                                            type: t,
                                            category: c,
                                            weight: parseFloat(fd.get('weight')),
                                            date: fd.get('date')
                                        });
                                    }}>
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Note</label>
                                                    <select name="value" className="w-full bg-slate-50 border-slate-200 rounded-xl px-3 py-3 font-bold">{[1,2,3,4,5,6].map(n=><option key={n} value={n}>{n}</option>)}</select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Tendenz</label>
                                                    <select name="trend" className="w-full bg-slate-50 border-slate-200 rounded-xl px-3 py-3 font-bold"><option value="">glatt</option><option value="+">+</option><option value="-">-</option></select>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Art</label>
                                                <select name="type" className="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 font-bold">
                                                    {GRADE_TYPES.map(t=><option key={t.type} value={t.type}>{t.label}</option>)}
                                                </select>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                    <span className="block text-xs text-slate-400 uppercase">Kategorie</span>
                                                    <span className="font-bold text-slate-700">Auto</span>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Gewichtung</label>
                                                    <select name="weight" className="w-full bg-slate-50 border-slate-200 rounded-xl px-3 py-3 font-bold"><option value="1">1.0 (Normal)</option><option value="2">2.0 (Doppelt)</option><option value="0.5">0.5 (Halbe)</option></select>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Datum</label>
                                                <input type="date" name="date" required defaultValue={new Date().toISOString().split('T')[0]} className="w-full bg-slate-50 border-slate-200 rounded-xl px-4 py-3 font-bold" />
                                            </div>
                                            <button type="submit" className={`w-full text-white font-bold py-4 rounded-xl hover:opacity-90 transition-opacity mt-2 ${simMode ? 'bg-blue-600 shadow-lg shadow-blue-200' : 'bg-black shadow-lg shadow-slate-200'}`}>
                                                {simMode ? 'Simulieren' : 'Speichern'}
                                            </button>
                                        </div>
                                    </form>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<GradeManager />);
    </script>
</body>
</html>
