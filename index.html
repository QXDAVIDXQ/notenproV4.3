<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotenManager Pro - Ultimate Final</title>
    
    <!-- 1. Design & Core Libraries -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- 3. Fonts (Die "guten" aus V3) -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        display: ['"Space Grotesk"', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif'],
                    },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' },
                        accent: { 500: '#6366f1', 600: '#4f46e5' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(15px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        
        /* A4 Preview CSS - Optimiert für Skalierung */
        .a4-preview {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;

        // --- ICONS (Fixierte V3 Icons) ---
        const Icon = ({ name, size = 20, className = '' }) => {
            const paths = {
                Plus: <path d="M12 5v14M5 12h14" />,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                BarChart2: <><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></>,
                Layout: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></>,
                FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>,
                ChevronRight: <polyline points="9 18 15 12 9 6"/>,
                ChevronDown: <polyline points="6 9 12 15 18 9"/>,
                TrendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>,
                Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                Award: <><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>,
                Beaker: <><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></>,
                Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
                PieChart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z"/>,
                Book: <><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
                Target: <><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {paths[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        const ChartEngine = {
            getSmoothPath: (points) => {
                if (points.length === 0) return "";
                if (points.length === 1) return `M 0 ${points[0].y} L 100 ${points[0].y}`;
                let d = `M ${points[0].x} ${points[0].y}`;
                for (let i = 0; i < points.length - 1; i++) {
                    const p0 = points[i > 0 ? i - 1 : i];
                    const p1 = points[i];
                    const p2 = points[i + 1];
                    const p3 = points[i + 2 < points.length ? i + 2 : i + 1];
                    const cp1x = p1.x + (p2.x - p0.x) / 6;
                    const cp1y = p1.y + (p2.y - p0.y) / 6;
                    const cp2x = p2.x - (p3.x - p1.x) / 6;
                    const cp2y = p2.y - (p3.y - p1.y) / 6;
                    d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
                }
                return d;
            }
        };

        const GRADE_TYPES = [
            { type: 'Schulaufgabe', category: 'GL', label: 'Schulaufgabe' },
            { type: 'Kurzarbeit', category: 'KL', label: 'Kurzarbeit' },
            { type: 'Ex', category: 'KL', label: 'Stegreifaufgabe' },
            { type: 'Abfrage', category: 'KL', label: 'Abfrage' },
            { type: 'Referat', category: 'KL', label: 'Referat' },
            { type: 'Unterrichtsbeitrag', category: 'KL', label: 'Mündlich' },
            { type: 'Sonstiges', category: 'KL', label: 'Sonstiges' },
        ];

        const calculateStats = (subject) => {
            const grades = subject.grades;
            const glGrades = grades.filter(g => g.category === 'GL');
            const klGrades = grades.filter(g => g.category === 'KL');
            const avg = (arr) => {
                if (!arr.length) return null;
                const sum = arr.reduce((acc, g) => acc + (g.value * g.weight), 0);
                const w = arr.reduce((acc, g) => acc + g.weight, 0);
                return w === 0 ? 0 : sum / w;
            };
            const glAvg = avg(glGrades);
            const klAvg = avg(klGrades);
            let final = null;
            if (subject.isCore) {
                if (glAvg && klAvg) final = (glAvg * 2 + klAvg) / 3;
                else if (glAvg) final = glAvg;
                else if (klAvg) final = klAvg;
            } else {
                final = avg(grades);
            }
            return { avg: final, glAvg, klAvg, count: grades.length };
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- COMPONENTS ---

        const CleanChart = ({ data, color = "#0ea5e9", height = 200 }) => {
            if (!data || data.length < 2) return <div className="flex items-center justify-center h-full text-slate-400 text-sm font-medium bg-slate-50 rounded-xl">Zu wenig Daten für Verlauf</div>;
            const points = data.map((d, i) => ({
                x: (i / (data.length - 1)) * 100,
                y: 100 - ((d.value - 1) / 5) * 100 
            }));
            const pathD = ChartEngine.getSmoothPath(points);
            const areaD = `${pathD} L 100 100 L 0 100 Z`;
            return (
                <div className="w-full relative overflow-hidden rounded-xl bg-white" style={{ height: `${height}px` }}>
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full">
                        <defs>
                            <linearGradient id={`grad-${color}`} x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stopColor={color} stopOpacity="0.2" />
                                <stop offset="100%" stopColor={color} stopOpacity="0" />
                            </linearGradient>
                        </defs>
                        {[1, 2, 3, 4, 5, 6].map(n => {
                            const y = 100 - ((n - 1) / 5) * 100;
                            return <line key={n} x1="0" y1={y} x2="100" y2={y} stroke="#f1f5f9" strokeWidth="0.5" vectorEffect="non-scaling-stroke" />;
                        })}
                        <path d={areaD} fill={`url(#grad-${color})`} />
                        <path d={pathD} fill="none" stroke={color} strokeWidth="3" vectorEffect="non-scaling-stroke" strokeLinecap="round" strokeLinejoin="round" />
                    </svg>
                </div>
            );
        };

        const StatCard = ({ icon, title, value, sub, color = "bg-white" }) => (
            <div className={`p-6 rounded-3xl shadow-sm border border-slate-100 ${color} flex flex-col justify-between card-hover`}>
                <div className="flex justify-between items-start mb-4">
                    <div className="p-3 bg-white/50 rounded-2xl backdrop-blur-sm shadow-sm">{icon}</div>
                </div>
                <div>
                    <div className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">{title}</div>
                    <div className="text-2xl font-display font-bold text-slate-800">{value}</div>
                    {sub && <div className="text-xs text-slate-400 mt-1 font-medium">{sub}</div>}
                </div>
            </div>
        );

        // --- ADD GRADE MODAL (WITH TABS & QUICK SELECT) ---
        const AddGradeModal = ({ onClose, onSave, isSim }) => {
            const [mode, setMode] = useState('quick'); 
            const [data, setData] = useState({ value: '1', trend: '', type: 'Schulaufgabe', category: 'GL', weight: '1', date: new Date().toISOString().split('T')[0] });
            const [showOptions, setShowOptions] = useState(false);

            const handleSave = () => onSave({ ...data, value: parseInt(data.value), weight: parseFloat(data.weight) });
            const quickSave = (type, cat, weight) => onSave({ ...data, value: parseInt(data.value), type, category: cat, weight: parseFloat(weight) });

            return (
                <div className="bg-white rounded-3xl w-full max-w-md shadow-2xl animate-slide-up relative overflow-hidden">
                    <div className={`p-6 border-b flex justify-between items-center ${isSim ? 'bg-blue-50' : 'bg-slate-50'}`}>
                        <h3 className="font-bold text-xl text-slate-800">{isSim ? 'Simulation' : 'Note eintragen'}</h3>
                        <button onClick={onClose}><Icon name="X" className="text-slate-400 hover:text-slate-600"/></button>
                    </div>
                    
                    {/* TABS */}
                    <div className="flex border-b border-slate-100">
                        <button onClick={()=>setMode('quick')} className={`flex-1 py-3 text-sm font-bold ${mode==='quick'?'text-brand-600 border-b-2 border-brand-600':'text-slate-400 hover:text-slate-600'}`}>Schnell</button>
                        <button onClick={()=>setMode('detail')} className={`flex-1 py-3 text-sm font-bold ${mode==='detail'?'text-brand-600 border-b-2 border-brand-600':'text-slate-400 hover:text-slate-600'}`}>Manuell</button>
                    </div>

                    <div className="p-6 space-y-6">
                        {/* 1. GRADE SELECTOR */}
                        <div>
                            <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Note</label>
                            <div className="flex justify-between gap-2 mb-2">
                                {[1, 2, 3, 4, 5, 6].map(n => (
                                    <button key={n} onClick={() => setData({...data, value: n.toString()})} 
                                        className={`flex-1 py-3 rounded-xl font-bold text-xl transition-all border-2 ${data.value == n ? 'border-brand-600 bg-brand-600 text-white shadow-lg' : 'border-slate-100 bg-white text-slate-500 hover:border-slate-300'}`}>
                                        {n}
                                    </button>
                                ))}
                            </div>
                            <div className="flex justify-center gap-2">
                                {['-', '', '+'].map(t => (
                                    <button key={t} onClick={() => setData({...data, trend: t})} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${data.trend === t ? 'bg-slate-800 text-white' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}>
                                        {t || 'glatt'}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* 2. MODE CONTENT */}
                        {mode === 'quick' ? (
                            <div className="space-y-3 animate-fade-in">
                                <label className="block text-xs font-bold text-slate-400 uppercase">Speichern als...</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => quickSave('Schulaufgabe', 'GL', '1')} className="p-4 rounded-xl border-2 border-blue-100 bg-blue-50 text-blue-900 hover:bg-blue-100 hover:border-blue-300 text-left transition-all group">
                                        <div className="font-bold">Schulaufgabe</div>
                                        <div className="text-xs text-blue-500">Groß (GL)</div>
                                    </button>
                                    <button onClick={() => quickSave('Ex', 'KL', '1')} className="p-4 rounded-xl border-2 border-emerald-100 bg-emerald-50 text-emerald-900 hover:bg-emerald-100 hover:border-emerald-300 text-left transition-all group">
                                        <div className="font-bold">Ex / Stegreif</div>
                                        <div className="text-xs text-emerald-500">Klein (KL)</div>
                                    </button>
                                    <button onClick={() => quickSave('Abfrage', 'KL', '1')} className="p-4 rounded-xl border-2 border-amber-100 bg-amber-50 text-amber-900 hover:bg-amber-100 hover:border-amber-300 text-left transition-all group">
                                        <div className="font-bold">Abfrage</div>
                                        <div className="text-xs text-amber-500">Klein (KL)</div>
                                    </button>
                                    <button onClick={() => quickSave('Unterrichtsbeitrag', 'KL', '1')} className="p-4 rounded-xl border-2 border-purple-100 bg-purple-50 text-purple-900 hover:bg-purple-100 hover:border-purple-300 text-left transition-all group">
                                        <div className="font-bold">Mündlich</div>
                                        <div className="text-xs text-purple-500">Klein (KL)</div>
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4 animate-fade-in">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Art</label>
                                    <select value={data.type} onChange={e=>{
                                        const t=e.target.value; const c=GRADE_TYPES.find(x=>x.type===t)?.defaultCategory||'KL'; setData({...data, type: t, category: c});
                                    }} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 font-bold focus:ring-2 focus:ring-brand-500 outline-none">
                                        {GRADE_TYPES.map(t=><option key={t.type} value={t.type}>{t.label}</option>)}
                                    </select>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Kategorie</label>
                                        <select value={data.category} onChange={e=>setData({...data, category: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                                            <option value="GL">Groß (GL)</option><option value="KL">Klein (KL)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Gewichtung</label>
                                        <select value={data.weight} onChange={e=>setData({...data, weight: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                                            <option value="0.5">0.5 (Halb)</option><option value="1">1.0 (Einfach)</option><option value="2">2.0 (Doppelt)</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Datum</label>
                                    <input type="date" value={data.date} onChange={e=>setData({...data, date: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none" />
                                </div>
                                <button onClick={handleSave} className="w-full py-3 bg-brand-600 text-white rounded-xl font-bold shadow-lg hover:bg-brand-700 transition-all mt-4">Speichern</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const GradeManager = () => {
            const [subjects, setSubjects] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [simMode, setSimMode] = useState(false);
            const [simulatedGrades, setSimulatedGrades] = useState({}); 
            const [isModalOpen, setModalOpen] = useState(false);
            const [modalType, setModalType] = useState(null);
            
            useEffect(() => {
                const load = localStorage.getItem('notenmanager_v7_pro');
                if(load) setSubjects(JSON.parse(load));
                else setSubjects([
                    { id: '1', name: 'Deutsch', isCore: true, grades: [] },
                    { id: '2', name: 'Mathematik', isCore: true, grades: [] },
                    { id: '3', name: 'Englisch', isCore: true, grades: [] }
                ]);
            }, []);

            useEffect(() => {
                if(subjects.length) localStorage.setItem('notenmanager_v7_pro', JSON.stringify(subjects));
            }, [subjects]);

            const getEffectiveSubjects = () => {
                return subjects.map(sub => {
                    if(!simMode) return sub;
                    const sims = simulatedGrades[sub.id] || [];
                    return { ...sub, grades: [...sub.grades, ...sims] };
                });
            };

            const effectiveSubjects = getEffectiveSubjects();
            const globalAvg = (() => {
                const avgs = effectiveSubjects.map(s => calculateStats(s).avg).filter(a => a !== null);
                return avgs.length ? (avgs.reduce((a,b)=>a+b,0) / avgs.length).toFixed(2) : '-';
            })();

            const addSubject = (name, isCore) => {
                setSubjects([...subjects, { id: generateId(), name, isCore, grades: [] }]);
                setModalOpen(false);
            };

            const addGrade = (subjectId, gradeData) => {
                if(simMode) {
                    const newSim = { ...gradeData, id: generateId(), isSimulated: true };
                    setSimulatedGrades(prev => ({ ...prev, [subjectId]: [...(prev[subjectId]||[]), newSim] }));
                } else {
                    setSubjects(prev => prev.map(s => s.id === subjectId ? { ...s, grades: [...s.grades, { ...gradeData, id: generateId() }] } : s));
                }
                setModalOpen(false);
            };

            const deleteGrade = (subjectId, gradeId, isSim) => {
                if(isSim) setSimulatedGrades(prev => ({ ...prev, [subjectId]: prev[subjectId].filter(g => g.id !== gradeId) }));
                else setSubjects(prev => prev.map(s => s.id === subjectId ? { ...s, grades: s.grades.filter(g => g.id !== gradeId) } : s));
            };

            const downloadPDF = async () => {
                const element = document.getElementById('certificate-print-area');
                if(!element) return;
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, windowWidth: 794 });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = 210;
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('Zwischenzeugnis.pdf');
            };

            // RENDER: Dashboard
            const renderDashboard = () => {
                const rankedSubjects = [...effectiveSubjects]
                    .map(s => ({ name: s.name, avg: calculateStats(s).avg }))
                    .filter(s => s.avg !== null)
                    .sort((a,b) => a.avg - b.avg);
                const bestSubject = rankedSubjects.length ? rankedSubjects[0] : null;

                const weekdayStats = (() => {
                    const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
                    const stats = new Array(7).fill(0).map(() => ({ sum: 0, count: 0 }));
                    effectiveSubjects.flatMap(s => s.grades).forEach(g => {
                        const d = new Date(g.date).getDay();
                        stats[d].sum += g.value;
                        stats[d].count++;
                    });
                    const best = stats.map((s, i) => ({ avg: s.count ? s.sum/s.count : 99, i })).sort((a,b) => a.avg - b.avg)[0];
                    return stats[best.i].count > 0 ? days[best.i] : '-';
                })();

                const globalHistory = (() => {
                    const allDates = [...new Set(effectiveSubjects.flatMap(s => s.grades.map(g => g.date)))].sort();
                    if(allDates.length < 2) return [];
                    return allDates.map(date => {
                        const current = new Date(date);
                        const subAvgs = effectiveSubjects.map(s => {
                            const gradesUntil = s.grades.filter(g => new Date(g.date) <= current);
                            return calculateStats({...s, grades: gradesUntil}).avg;
                        }).filter(a => a !== null);
                        if(!subAvgs.length) return null;
                        return { date, value: subAvgs.reduce((a,b)=>a+b,0)/subAvgs.length };
                    }).filter(d => d !== null);
                })();

                return (
                    <div className="space-y-8 animate-fade-in pb-20">
                        <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                            <div>
                                <h1 className="text-4xl font-display font-bold text-slate-900">Dashboard</h1>
                                <p className="text-slate-500 mt-1">Hier ist dein aktueller Leistungsstand.</p>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setSimMode(!simMode)} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl font-bold transition-all ${simMode ? 'bg-accent-600 text-white shadow-lg shadow-accent-200' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>
                                    <Icon name="Beaker" size={18}/> {simMode ? 'Simulation beenden' : 'Simulieren'}
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <StatCard icon={<Icon name="Award" className="text-brand-600"/>} title="Gesamtschnitt" value={globalAvg} sub="Durchschnitt aller Fächer" color="bg-white"/>
                            <StatCard icon={<Icon name="TrendingUp" className="text-emerald-500"/>} title="Bestes Fach" value={bestSubject ? bestSubject.avg.toFixed(2) : '-'} sub={bestSubject ? bestSubject.name : ''} color="bg-emerald-50/50 border-emerald-100"/>
                            <StatCard icon={<Icon name="Zap" className="text-amber-500"/>} title="Bester Wochentag" value={weekdayStats} sub="Statistisch gesehen" color="bg-amber-50/50 border-amber-100"/>
                            <StatCard icon={<Icon name="Layout" className="text-accent-500"/>} title="Anzahl Noten" value={effectiveSubjects.flatMap(s=>s.grades).length} sub="Eingetragene Leistungen" color="bg-accent-50/50 border-accent-100"/>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-2 bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                                <div className="flex justify-between items-center mb-8">
                                    <h3 className="font-bold text-slate-800 flex gap-2 items-center"><Icon name="BarChart2" className="text-brand-500"/> Gesamtentwicklung</h3>
                                </div>
                                <div className="h-72"><CleanChart data={globalHistory} /></div>
                            </div>
                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                                <h3 className="font-bold text-slate-800 mb-6 flex gap-2 items-center"><Icon name="PieChart" className="text-accent-500"/> Notenspiegel</h3>
                                <div className="flex items-end justify-between h-64 gap-2">
                                    {[1,2,3,4,5,6].map(n => {
                                        const count = effectiveSubjects.flatMap(s => s.grades).filter(g => Math.round(g.value) === n).length;
                                        const max = Math.max(...[1,2,3,4,5,6].map(num => effectiveSubjects.flatMap(s => s.grades).filter(g => Math.round(g.value) === num).length)) || 1;
                                        const h = (count / max) * 100;
                                        return (
                                            <div key={n} className="w-full flex flex-col items-center group relative">
                                                <div className="mb-2 text-xs font-bold text-slate-800 opacity-0 group-hover:opacity-100 transition-opacity absolute -top-6">{count}x</div>
                                                <div style={{height: `${h || 2}%`}} className={`w-full rounded-lg transition-all duration-500 ${n <= 2 ? 'bg-emerald-400' : n <= 4 ? 'bg-amber-400' : 'bg-red-400'} opacity-80 group-hover:opacity-100`}></div>
                                                <span className="text-xs font-bold mt-3 text-slate-400">{n}</span>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-slate-800">Fächerübersicht</h3>
                                <button onClick={() => { setModalType('addSubject'); setModalOpen(true); }} className="text-sm font-bold text-brand-600 bg-brand-50 px-4 py-2 rounded-xl hover:bg-brand-100 transition-colors flex items-center gap-2">
                                    <Icon name="Plus" size={16}/> Fach hinzufügen
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {effectiveSubjects.map(sub => {
                                    const stats = calculateStats(sub);
                                    return (
                                        <div key={sub.id} onClick={() => { setSelectedSubject(sub.id); setActiveTab('details'); }} 
                                             className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer relative overflow-hidden group">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h4 className="font-bold text-lg text-slate-800">{sub.name}</h4>
                                                    <span className="text-xs text-slate-400 uppercase font-bold tracking-wider">{sub.isCore ? 'Kernfach' : 'Nebenfach'}</span>
                                                </div>
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-display font-bold text-lg ${stats.avg <= 2.5 ? 'bg-emerald-100 text-emerald-700' : stats.avg <= 3.5 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>
                                                    {stats.avg ? stats.avg.toFixed(1) : '-'}
                                                </div>
                                            </div>
                                            <div className={`absolute bottom-0 left-0 h-1 w-full ${sub.isCore ? 'bg-brand-500' : 'bg-emerald-400'} opacity-0 group-hover:opacity-100 transition-opacity`}></div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            // RENDER: Details
            const renderDetails = () => {
                const sub = effectiveSubjects.find(s => s.id === selectedSubject);
                if(!sub) return null;
                const stats = calculateStats(sub);
                
                const history = sub.grades.sort((a,b)=>new Date(a.date)-new Date(b.date)).map((g, i, arr) => {
                    const subset = arr.slice(0, i+1);
                    return { value: calculateStats({...sub, grades: subset}).avg, date: g.date };
                });

                return (
                    <div className="space-y-8 animate-slide-up pb-20">
                        <button onClick={() => setActiveTab('dashboard')} className="flex items-center text-sm font-bold text-slate-400 hover:text-brand-600 transition-colors mb-4 gap-1">
                            <span className="text-lg">←</span> Zurück
                        </button>
                        
                        <div className="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
                            <div>
                                <h1 className="text-4xl font-display font-bold text-slate-900">{sub.name}</h1>
                                <span className="inline-block mt-2 px-3 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-500 uppercase tracking-wider">{sub.isCore ? 'Kernfach (2:1)' : 'Nebenfach (1:1)'}</span>
                            </div>
                            <div className="text-center md:text-right">
                                <div className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-1">Durchschnitt</div>
                                <div className="text-6xl font-display font-bold text-brand-600">{stats.avg ? stats.avg.toFixed(2) : '-'}</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                <span className="text-slate-400 text-xs font-bold uppercase">Schriftlich (GL)</span>
                                <div className="text-3xl font-bold text-slate-800 mt-2">{stats.glAvg ? stats.glAvg.toFixed(2) : '-'}</div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                <span className="text-slate-400 text-xs font-bold uppercase">Mündlich (KL)</span>
                                <div className="text-3xl font-bold text-slate-800 mt-2">{stats.klAvg ? stats.klAvg.toFixed(2) : '-'}</div>
                            </div>
                            
                            <div className="bg-slate-900 text-white p-6 rounded-3xl shadow-lg">
                                <div className="flex items-center gap-2 mb-4 font-bold text-brand-400"><Icon name="Target"/> Ziel-Check</div>
                                <div className="flex gap-2">
                                    <input id="targetInput" type="number" placeholder="Zielnote (z.B. 2.0)" className="w-full bg-slate-800 border-none rounded-xl px-4 text-sm text-white focus:ring-1 focus:ring-brand-500"/>
                                    <button onClick={() => {
                                        const t = parseFloat(document.getElementById('targetInput').value);
                                        if(!t) return;
                                        for(let i=0.5; i<=6; i+=0.25) {
                                            const simG = [...sub.grades, { value: i, weight: 1, category: 'KL' }];
                                            const newA = calculateStats({...sub, grades: simG}).avg;
                                            if(newA && ((t < stats.avg && newA <= t) || (t > stats.avg && newA >= t))) {
                                                alert(`Eine ${i.toFixed(2)} (KL) würde reichen.`); return;
                                            }
                                        }
                                        alert("Schwer erreichbar.");
                                    }} className="bg-brand-600 px-4 rounded-xl font-bold hover:bg-brand-500 transition-colors">Go</button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                            <h3 className="font-bold text-slate-800 mb-6">Verlauf</h3>
                            <div className="h-64">
                                <CleanChart data={history} color={sub.isCore ? '#3b82f6' : '#10b981'} />
                            </div>
                        </div>

                        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <div className="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                                <h3 className="font-bold text-slate-800">Notenliste</h3>
                                <button onClick={() => { setModalType('addGrade'); setModalOpen(true); }} className="bg-slate-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-800 transition-colors">
                                    <Icon name="Plus" size={16}/> Note
                                </button>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-white text-slate-400 uppercase font-bold text-xs border-b border-slate-50">
                                        <tr><th className="p-4 pl-6">Datum</th><th className="p-4">Art</th><th className="p-4">Note</th><th className="p-4 text-right"></th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {sub.grades.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(g => (
                                            <tr key={g.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="p-4 pl-6 font-medium text-slate-500">{new Date(g.date).toLocaleDateString()}</td>
                                                <td className="p-4">
                                                    <span className="font-bold text-slate-800 block">{g.type}</span>
                                                    <span className="text-xs text-slate-400">{g.category} • x{g.weight}</span>
                                                </td>
                                                <td className="p-4">
                                                    <span className={`text-lg font-bold ${g.value<=2?'text-emerald-600':g.value<=4?'text-amber-600':'text-red-600'}`}>{g.value}{g.trend}</span>
                                                    {g.isSimulated && <span className="ml-2 bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase">Sim</span>}
                                                </td>
                                                <td className="p-4 text-right pr-6">
                                                    <button onClick={() => deleteGrade(sub.id, g.id, g.isSimulated)} className="text-slate-300 hover:text-red-500 p-2"><Icon name="Trash2" size={18}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            // RENDER: Certificate
            const renderCertificate = () => {
                // GS E (Einfach)
                const validSubjects = effectiveSubjects.filter(s => calculateStats(s).avg !== null);
                const gsE = validSubjects.length ? (validSubjects.reduce((acc, s) => acc + calculateStats(s).avg, 0) / validSubjects.length).toFixed(2) : '-';

                // GS G/K (GSO)
                const subjectsWithGL = effectiveSubjects.filter(s => s.isCore && s.grades.some(g => g.category === 'GL'));
                const subjectsWithKL = effectiveSubjects.filter(s => s.grades.length > 0); 
                let gsGK = '-';
                if (subjectsWithGL.length > 0 || subjectsWithKL.length > 0) {
                    const avgGLCore = subjectsWithGL.length ? subjectsWithGL.reduce((acc, s) => acc + calculateStats(s).glAvg, 0) / subjectsWithGL.length : 0;
                    const avgKLAll = subjectsWithKL.length ? subjectsWithKL.reduce((acc, s) => {
                        const stats = calculateStats(s); return acc + (s.isCore ? stats.klAvg : stats.avg);
                    }, 0) / subjectsWithKL.length : 0;
                    const countCore = subjectsWithGL.length;
                    const countAll = subjectsWithKL.length;
                    const denom = countAll + (countCore * 2);
                    if(denom > 0) gsGK = (((avgGLCore * countCore * 2) + (avgKLAll * countAll)) / denom).toFixed(2);
                }

                return (
                    <div className="pb-20 animate-fade-in flex flex-col items-center">
                        <div className="w-full max-w-4xl mb-6 flex justify-end">
                            <button onClick={downloadPDF} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-800 flex items-center gap-2 transition-all">
                                <Icon name="Download"/> PDF speichern
                            </button>
                        </div>

                        <div id="certificate-print-area" className="a4-preview p-12 relative text-slate-900 mx-auto overflow-hidden flex flex-col">
                            {/* Header */}
                            <div className="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-brand-600 via-accent-500 to-brand-600"></div>
                            
                            <div className="flex justify-between items-end mb-10 mt-4 border-b border-slate-100 pb-6">
                                <div>
                                    <div className="text-xs font-bold uppercase tracking-[0.2em] text-slate-400 mb-1">Offizielles Dokument</div>
                                    <div className="text-4xl font-serif font-bold text-slate-900">Zwischenzeugnis</div>
                                    <div className="text-sm italic text-slate-500 mt-1">Schuljahr {new Date().getFullYear()}/{new Date().getFullYear()+1}</div>
                                </div>
                                <div className="text-right">
                                    {simMode && <div className="mb-2 inline-block bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-widest">Inkl. Simulation</div>}
                                    <div className="text-sm font-bold text-slate-500">{new Date().toLocaleDateString()}</div>
                                </div>
                            </div>

                            {/* COMPACT Table for 12+ Subjects */}
                            <div className="flex-grow">
                                <table className="w-full border-collapse font-sans">
                                    <thead>
                                        <tr className="border-b-2 border-slate-900 text-left">
                                            <th className="py-2 text-xs font-bold text-slate-400 uppercase tracking-widest w-1/3">Fach</th>
                                            <th className="py-2 text-xs font-bold text-slate-400 uppercase tracking-widest">Zusammensetzung</th>
                                            <th className="py-2 text-xs font-bold text-slate-400 uppercase tracking-widest text-right">Note</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm">
                                        {effectiveSubjects.map(sub => {
                                            const stats = calculateStats(sub);
                                            return (
                                                <tr key={sub.id} className="border-b border-slate-100">
                                                    <td className="py-3 font-bold text-slate-800">
                                                        {sub.name}
                                                        {sub.isCore && <span className="ml-2 text-[10px] text-slate-400 uppercase font-normal tracking-wide">Kern</span>}
                                                    </td>
                                                    <td className="py-3 text-slate-500 text-xs">
                                                        {stats.avg ? (
                                                            sub.isCore ? 
                                                            <span>GL: <strong>{stats.glAvg?.toFixed(2)||'-'}</strong> &nbsp;|&nbsp; KL: <strong>{stats.klAvg?.toFixed(2)||'-'}</strong></span> 
                                                            : <span>Gesamt (KL)</span>
                                                        ) : <span className="italic opacity-50">-</span>}
                                                    </td>
                                                    <td className="py-3 text-right font-bold text-lg text-slate-900">{stats.avg ? stats.avg.toFixed(2) : '-'}</td>
                                                </tr>
                                            )
                                        })}
                                    </tbody>
                                </table>
                            </div>

                            {/* Footer Stats */}
                            <div className="mt-8 grid grid-cols-2 gap-6 bg-slate-50 p-6 rounded-xl border border-slate-100">
                                <div className="text-center border-r border-slate-200">
                                    <div className="text-[10px] font-bold uppercase tracking-widest text-slate-400">GS E (Endnoten)</div>
                                    <div className="text-3xl font-display font-bold text-slate-800">{gsE}</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-[10px] font-bold uppercase tracking-widest text-slate-400">GS G/K (GSO)</div>
                                    <div className="text-3xl font-display font-bold text-slate-900">{gsGK}</div>
                                </div>
                            </div>

                            <div className="mt-8 flex justify-between font-sans text-[10px] uppercase tracking-widest text-slate-400">
                                <div className="text-center w-1/3"><div className="h-px bg-slate-300 mb-2"></div>Klassenleitung</div>
                                <div className="text-center w-1/3"><div className="h-px bg-slate-300 mb-2"></div>Erziehungsberechtigte</div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderAnalytics = () => {
                const grades = effectiveSubjects.flatMap(s => s.grades);
                const typeData = {};
                grades.forEach(g => {
                    if(!typeData[g.type]) typeData[g.type] = { sum: 0, count: 0 };
                    typeData[g.type].sum += g.value; typeData[g.type].count++;
                });
                const types = Object.keys(typeData).map(k => ({ label: k, avg: typeData[k].sum/typeData[k].count, count: typeData[k].count }));

                return (
                    <div className="space-y-8 animate-fade-in pb-20">
                        <h1 className="text-3xl font-display font-bold text-slate-900">Statistik Center</h1>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                                <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><Icon name="Layout" className="text-brand-500"/> Leistung nach Art</h3>
                                <div className="space-y-6">
                                    {types.sort((a,b)=>a.avg-b.avg).map(t => (
                                        <div key={t.label}>
                                            <div className="flex justify-between text-sm font-bold text-slate-700 mb-2"><span>{t.label} <span className="text-xs text-slate-400 font-normal ml-1">({t.count})</span></span><span>{t.avg.toFixed(2)} Ø</span></div>
                                            <div className="h-3 w-full bg-slate-100 rounded-full overflow-hidden"><div style={{width: `${((6-t.avg)/5)*100}%`}} className={`h-full rounded-full ${t.avg<=2.5?'bg-emerald-400':t.avg<=3.5?'bg-amber-400':'bg-red-400'}`}></div></div>
                                        </div>
                                    ))}
                                    {types.length===0 && <div className="text-center text-slate-400">Keine Daten</div>}
                                </div>
                            </div>
                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-center items-center text-center">
                                <div className="p-4 bg-brand-50 rounded-full mb-4 text-brand-600"><Icon name="Award" size={40}/></div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">Dein Leistungs-Profil</h3>
                                <p className="text-slate-500 mb-6">Basierend auf {grades.length} Noten</p>
                                <div className="text-4xl font-display font-bold text-slate-900">{globalAvg}</div>
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Gesamtschnitt</div>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- APP SHELL ---
            return (
                <div className="flex min-h-screen">
                    <aside className="w-20 lg:w-72 bg-white border-r border-slate-100 flex-shrink-0 flex flex-col sticky top-0 h-screen z-50">
                        <div className="p-8 flex items-center gap-4">
                            <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-lg"><Icon name="Award"/></div>
                            <span className="font-display font-bold text-2xl hidden lg:block text-slate-900">NotenPro</span>
                        </div>
                        <nav className="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                            {[{ id: 'dashboard', label: 'Dashboard', icon: 'Layout' }, { id: 'analytics', label: 'Statistik', icon: 'BarChart2' }, { id: 'certificate', label: 'Zeugnis', icon: 'FileText' }].map(item => (
                                <button key={item.id} onClick={() => { setActiveTab(item.id); setSelectedSubject(null); }} 
                                    className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === item.id ? 'bg-slate-900 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <Icon name={item.icon} className={activeTab === item.id ? 'text-white' : 'text-slate-400'} />
                                    <span className="hidden lg:block">{item.label}</span>
                                </button>
                            ))}
                            <div className="pt-8 pb-2 px-4 text-xs font-bold text-slate-400 uppercase tracking-widest hidden lg:block">Fächer</div>
                            <div className="space-y-1">
                                {subjects.map(s => (
                                    <button key={s.id} onClick={() => { setSelectedSubject(s.id); setActiveTab('details'); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left font-medium ${selectedSubject === s.id && activeTab === 'details' ? 'bg-brand-50 text-brand-700' : 'text-slate-500 hover:bg-slate-50'}`}>
                                        <div className={`w-2 h-2 rounded-full ${s.isCore ? 'bg-brand-500' : 'bg-emerald-400'}`}></div>
                                        <span className="hidden lg:block truncate">{s.name}</span>
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => { setModalType('addSubject'); setModalOpen(true); }} className="w-full mt-4 border-2 border-dashed border-slate-200 rounded-xl p-3 text-slate-400 hover:border-brand-300 hover:text-brand-500 transition-all flex justify-center"><Icon name="Plus"/></button>
                        </nav>
                    </aside>

                    <main className="flex-1 bg-slate-50/50 p-4 lg:p-10 overflow-y-auto h-screen">
                        <div className="max-w-7xl mx-auto">
                            {activeTab === 'dashboard' && renderDashboard()}
                            {activeTab === 'details' && renderDetails()}
                            {activeTab === 'certificate' && renderCertificate()}
                            {activeTab === 'analytics' && renderAnalytics()}
                        </div>
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in">
                            {modalType === 'addSubject' && (
                                <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md animate-slide-up relative">
                                    <button onClick={() => setModalOpen(false)} className="absolute top-6 right-6 text-slate-400 hover:text-slate-600"><Icon name="Trash2" className="rotate-45" size={24}/></button>
                                    <h2 className="text-2xl font-bold text-slate-900 mb-6">Neues Fach</h2>
                                    <form onSubmit={(e)=>{e.preventDefault(); addSubject(e.target.name.value, e.target.core.checked)}}>
                                        <div className="space-y-4">
                                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Name</label><input autoFocus required name="name" className="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 font-bold focus:ring-2 focus:ring-brand-500"/></div>
                                            <div className="flex items-center gap-3 bg-slate-50 p-4 rounded-xl"><input type="checkbox" name="core" className="w-5 h-5 text-brand-600 rounded border-gray-300 focus:ring-brand-500"/><label className="font-bold text-slate-700">Kernfach?</label></div>
                                            <button className="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition-colors">Erstellen</button>
                                        </div>
                                    </form>
                                </div>
                            )}
                            {modalType === 'addGrade' && <AddGradeModal onClose={() => setModalOpen(false)} onSave={(d) => addGrade(selectedSubject, d)} isSim={simMode} />}
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<GradeManager />);
    </script>
</body>
</html>
